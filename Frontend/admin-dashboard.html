<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم إدارة الرعاية الصحية</title>
    <!-- Bootstrap 5 RTL CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-rtl@5.3.0/dist/css/bootstrap-rtl.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- DataTables RTL CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #858796;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --dark-color: #5a5c69;
        }

        body {
            font-family: 'Tajawal', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fc;
        }

        /* Sidebar */
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 10%, #224abe 100%);
            transition: all 0.3s;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border-radius: 0.35rem;
            margin-bottom: 0.2rem;
        }

        .sidebar .nav-link:hover {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar .nav-link.active {
            color: #fff;
            background-color: rgba(255, 255, 255, 0.2);
        }

        .sidebar .nav-link i {
            margin-left: 0.5rem;
            margin-right: 0;
        }

        /* Cards */
        .card {
            border: none;
            border-radius: 0.35rem;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        }

        .card-header {
            background-color: #f8f9fc;
            border-bottom: 1px solid #e3e6f0;
            padding: 1rem 1.35rem;
            font-weight: 600;
        }

        /* Tables */
        .table {
            margin-bottom: 0;
        }

        .table th {
            font-weight: 600;
            color: var(--dark-color);
            border-top: none;
        }

        /* Buttons */
        .btn {
            border-radius: 0.35rem;
            font-weight: 600;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: #2e59d9;
            border-color: #2653d4;
        }

        /* Dashboard Stats */
        .stat-card {
            border-right: 0.25rem solid;
            border-radius: 0.35rem;
        }

        .stat-card.bg-primary {
            border-right-color: var(--primary-color);
        }

        .stat-card.bg-success {
            border-right-color: var(--success-color);
        }

        .stat-card.bg-info {
            border-right-color: var(--info-color);
        }

        .stat-card.bg-warning {
            border-right-color: var(--warning-color);
        }

        /* Image Previews */
        .img-preview-container {
            display: none;
        }

        .img-preview {
            max-height: 200px;
            object-fit: contain;
        }

        /* Ensure textarea is visible */
        #blogContent {
            display: block !important;
            width: 100%;
            min-height: 150px;
        }

        /* Fix modal body scrolling */
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Services table styling */
        #servicesTable {
            margin-bottom: 0;
        }

        #servicesTable tbody tr td {
            vertical-align: middle;
        }

        #servicesTable .btn-group {
            white-space: nowrap;
        }

        /* Department image preview */
        #departmentImagePreviewContainer {
            margin: 15px 0;
        }

        #departmentImagePreview {
            max-width: 100%;
            height: auto;
        }

        /* RTL adjustments */
        .dropdown-menu {
            text-align: right;
        }
        
        .form-select {
            background-position: left 0.75rem center;
            padding-right: 0.75rem;
            padding-left: 2.25rem;
        }
        
        .dataTables_wrapper .dataTables_filter {
            float: left;
        }
        
        .dataTables_wrapper .dataTables_length {
            float: right;
        }
        
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            float: right;
        }
        
        .me-2 {
            margin-left: 0.5rem !important;
            margin-right: 0 !important;
        }
        
        .ms-2 {
            margin-right: 0.5rem !important;
            margin-left: 0 !important;
        }
        
        .pe-2 {
            padding-left: 0.5rem !important;
            padding-right: 0 !important;
        }
        
        .ps-2 {
            padding-right: 0.5rem !important;
            padding-left: 0 !important;
        }
    </style>
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/logo.png">
</head>
<body class="d-flex">
    <!-- Sidebar -->
    <div class="d-flex flex-column flex-shrink-0 p-3 bg-dark text-white" style="width: 280px; height: 100vh;">
        <a href="#" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-white text-decoration-none">
            <img src="images/logo.png" alt="Healthcare Logo" width="40" class="me-2">
            <span class="fs-4">لوحة التحكم الإدارية</span>
        </a>
        <hr>
        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="#" class="nav-link active" id="dashboardTab">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    لوحة التحكم
                </a>
            </li>
            <li>
                <a href="#" class="nav-link text-white" id="doctorsTab">
                    <i class="fas fa-user-md me-2"></i>
                    الأطباء
                </a>
            </li>
            <li>
                <a href="#" class="nav-link text-white" id="departmentsTab">
                    <i class="fas fa-procedures me-2"></i>
                    الأقسام
                </a>
            </li>
            <li>
                <a href="#" class="nav-link text-white" id="blogsTab">
                    <i class="fas fa-blog me-2"></i>
                    المدونة
                </a>
            </li>
            <li>
                <a href="#" class="nav-link text-white" id="bookingsTab">
                    <i class="fas fa-calendar-check me-2"></i>
                    المواعيد
                </a>
            </li>
            <li>
                <a href="#" class="nav-link text-white" id="contactsTab">
                    <i class="fas fa-envelope me-2"></i>
                    رسائل التواصل
                </a>
            </li>
        </ul>
        <hr>
        <div class="dropdown">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" id="dropdownUser1" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="images/download (21).jpeg" alt="Admin" width="32" height="32" class="rounded-circle me-2">
                <strong id="adminName">المدير</strong>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark text-small shadow" aria-labelledby="dropdownUser1">
                <li><a class="dropdown-item" href="#">الملف الشخصي</a></li>
                <li><a class="dropdown-item" href="#">الإعدادات</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" id="logoutBtn">تسجيل الخروج</a></li>
            </ul>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 p-4" style="overflow-y: auto;">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2" id="pageTitle">لوحة التحكم</h1>
            <div class="btn-toolbar mb-2 mb-md-0">
                <div class="btn-group me-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary">تصدير</button>
                </div>
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
                    <i class="fas fa-calendar"></i> هذا الأسبوع
                </button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboardContent">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">الأطباء</h6>
                                    <h2 class="mb-0" id="doctorsCount">0</h2>
                                </div>
                                <i class="fas fa-user-md fa-3x opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">الأقسام</h6>
                                    <h2 class="mb-0" id="departmentsCount">0</h2>
                                </div>
                                <i class="fas fa-procedures fa-3x opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">المواعيد</h6>
                                    <h2 class="mb-0" id="appointmentsCount">0</h2>
                                </div>
                                <i class="fas fa-calendar-check fa-3x opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-dark">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="card-title">الرسائل</h6>
                                    <h2 class="mb-0" id="messagesCount">0</h2>
                                </div>
                                <i class="fas fa-envelope fa-3x opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-8">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>أحدث المواعيد</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover" id="recentAppointmentsTable">
                                    <thead>
                                        <tr>
                                            <th>المريض</th>
                                            <th>القسم</th>
                                            <th>التاريخ</th>
                                            <th>الحالة</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Will be populated by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5>أحدث الرسائل</h5>
                        </div>
                        <div class="card-body">
                            <div class="list-group" id="recentMessagesList">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Doctors Content -->
        <div id="doctorsContent" class="d-none">
            <div class="d-flex justify-content-between mb-3">
                <h2>إدارة الأطباء</h2>
                <button class="btn btn-primary" id="addDoctorBtn">
                    <i class="fas fa-plus me-1"></i> إضافة طبيب
                </button>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="doctorsTable">
                            <thead>
                                <tr>
                                    <th>الصورة</th>
                                    <th>الاسم</th>
                                    <th>التخصص</th>
                                    <th>القسم</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Departments Content -->
        <div id="departmentsContent" class="d-none">
            <div class="d-flex justify-content-between mb-3">
                <h2>إدارة الأقسام</h2>
                <button class="btn btn-primary" id="addDepartmentBtn">
                    <i class="fas fa-plus me-1"></i> إضافة قسم
                </button>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="departmentsTable">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>الوصف</th>
                                    <th>عدد الأطباء</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blogs Content -->
        <div id="blogsContent" class="d-none">
            <div class="d-flex justify-content-between mb-3">
                <h2>إدارة المقالات</h2>
                <button class="btn btn-primary" id="addBlogBtn">
                    <i class="fas fa-plus me-1"></i> إضافة مقال
                </button>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="blogsTable">
                            <thead>
                                <tr>
                                    <th>الصورة</th>
                                    <th>العنوان</th>
                                    <th>تاريخ النشر</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointments Content -->
        <div id="bookingsContent" class="d-none">
            <h2 class="mb-3">إدارة المواعيد</h2>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="appointmentsTable">
                            <thead>
                                <tr>
                                    <th>المريض</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>الهاتف</th>
                                    <th>القسم</th>
                                    <th>التاريخ</th>
                                    <th>الحالة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contact Messages Content -->
        <div id="contactsContent" class="d-none">
            <h2 class="mb-3">رسائل التواصل</h2>
            
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="contactsTable">
                            <thead>
                                <tr>
                                    <th>الاسم</th>
                                    <th>البريد الإلكتروني</th>
                                    <th>الرسالة</th>
                                    <th>التاريخ</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modals -->
        <!-- Add Doctor Modal -->
        <div class="modal fade" id="doctorModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="doctorModalTitle">إضافة طبيب جديد</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="doctorForm" enctype="multipart/form-data">
                            <input type="hidden" id="doctorId">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="doctorName" class="form-label">الاسم الكامل</label>
                                    <input type="text" class="form-control" id="doctorName" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="doctorSpecialty" class="form-label">التخصص</label>
                                    <input type="text" class="form-control" id="doctorSpecialty" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="doctorBio" class="form-label">السيرة الذاتية</label>
                                <textarea class="form-control" id="doctorBio" rows="3"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="doctorDepartment" class="form-label">القسم</label>
                                    <select class="form-select" id="doctorDepartment" required>
                                        <option value="">اختر القسم</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="doctorImage" class="form-label">صورة الطبيب</label>
                                    <input type="file" class="form-control" id="doctorImage" accept="image/*">
                                </div>
                            </div>
                            <div class="mb-3 text-center" id="doctorImagePreviewContainer">
                                <img id="doctorImagePreview" src="images/Download Free Photo _ Young arabic speaking doctor in medical uniform_.jpeg" alt="Doctor Preview" class="img-thumbnail" style="max-height: 200px;">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-primary" id="saveDoctorBtn">حفظ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Department Modal -->
       <!-- Add Department Modal -->
<div class="modal fade" id="departmentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="departmentModalTitle">إضافة قسم جديد</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="departmentForm" enctype="multipart/form-data">
                    <input type="hidden" id="departmentId">
                    <div class="mb-3">
                        <label for="departmentName" class="form-label">الاسم</label>
                        <input type="text" class="form-control" id="departmentName" required>
                    </div>
                    <div class="mb-3">
                        <label for="departmentDescription" class="form-label">الوصف</label>
                        <textarea class="form-control" id="departmentDescription" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="departmentImage" class="form-label">صورة القسم</label>
                        <input type="file" class="form-control" id="departmentImage" accept="image/*">
                    </div>
                    <div class="mb-3 text-center" id="departmentImagePreviewContainer" style="display: none;">
                        <img id="departmentImagePreview" src="" alt="Department Preview" class="img-thumbnail" style="max-height: 200px;">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">الخدمات</label>
                        <button type="button" class="btn btn-sm btn-primary mb-2" id="addServiceBtn">
                            <i class="fas fa-plus me-1"></i> إضافة خدمة
                        </button>
                        <div id="servicesContainer"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-primary" id="saveDepartmentBtn">حفظ</button>
            </div>
        </div>
    </div>
</div>

        <!-- Add Blog Modal -->
        <div class="modal fade" id="blogModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="blogModalTitle">إضافة مقال جديد</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
    <form id="blogForm" enctype="multipart/form-data">
        <input type="hidden" id="blogId">
        <div class="mb-3">
            <label for="blogTitle" class="form-label">العنوان</label>
            <input type="text" class="form-control" id="blogTitle" required>
        </div>
        <div class="mb-3">
            <label for="blogContent" class="form-label">المحتوى</label>
            <!-- Make sure this textarea exists and has proper ID -->
            <textarea class="form-control" id="blogContent" rows="5" required></textarea>
        </div>
        <div class="mb-3">
            <label for="blogImage" class="form-label">الصورة الرئيسية</label>
            <input type="file" class="form-control" id="blogImage" accept="image/*">
        </div>
        <div class="mb-3 text-center" id="blogImagePreviewContainer">
            <img id="blogImagePreview" src="https://via.placeholder.com/600x300" alt="Blog Preview" class="img-fluid" style="max-height: 200px;">
        </div>
    </form>
</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-primary" id="saveBlogBtn">حفظ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmationModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">تأكيد الإجراء</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p id="confirmationMessage">هل أنت متأكد أنك تريد حذف هذا العنصر؟</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                        <button type="button" class="btn btn-danger" id="confirmActionBtn">تأكيد</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <!-- DataTables -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- Custom JS -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Check authentication
    const token = localStorage.getItem('healthcare_token');
    const user = JSON.parse(localStorage.getItem('healthcare_user'));
    
    if (!token || !user || !user.roles.includes('Admin')) {
        window.location.href = 'login.html';
        return;
    }

    // Set admin name in sidebar
    document.getElementById('adminName').textContent = user.email.split('@')[0];

    // Initialize DataTables with Arabic language
    const initDataTable = (tableId, options = {}) => {
        return $(`#${tableId}`).DataTable({
            responsive: true,
            language: {
                "sProcessing":   "جارٍ التحميل...",
                "sLengthMenu":   "أظهر _MENU_ مدخلات",
                "sZeroRecords":  "لم يعثر على أية سجلات",
                "sInfo":         "إظهار _START_ إلى _END_ من أصل _TOTAL_ مدخل",
                "sInfoEmpty":    "يعرض 0 إلى 0 من أصل 0 سجل",
                "sInfoFiltered": "(منتقاة من مجموع _MAX_ مُدخل)",
                "sInfoPostFix":  "",
                "sSearch":       "ابحث:",
                "sUrl":          "",
                "oPaginate": {
                    "sFirst":    "الأول",
                    "sPrevious": "السابق",
                    "sNext":     "التالي",
                    "sLast":     "الأخير"
                },
                "aria": {
                    "sortAscending":  ": تفعيل لترتيب العمود تصاعدياً",
                    "sortDescending": ": تفعيل لترتيب العمود تنازلياً"
                }
            },
            ...options
        });
    };

    // Initialize all tables
    const doctorsTable = initDataTable('doctorsTable');
    const departmentsTable = initDataTable('departmentsTable');
    const blogsTable = initDataTable('blogsTable');
    const appointmentsTable = initDataTable('appointmentsTable');
    const contactsTable = initDataTable('contactsTable');

    // Tab switching
    const tabs = ['dashboard', 'doctors', 'departments', 'blogs', 'bookings', 'contacts'];
    tabs.forEach(tab => {
        document.getElementById(`${tab}Tab`).addEventListener('click', function(e) {
            e.preventDefault();
            
            // Update active tab
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            this.classList.add('active');
            
            // Update page title
            document.getElementById('pageTitle').textContent = this.textContent.trim();
            
            // Show correct content
            document.querySelectorAll('[id$="Content"]').forEach(content => content.classList.add('d-none'));
            document.getElementById(`${tab}Content`).classList.remove('d-none');
            
            // Refresh data if needed
            if (tab === 'dashboard') {
                loadDashboardData();
            }
        });
    });

    // Load dashboard data
    async function loadDashboardData() {
        try {
            const [doctorsRes, departmentsRes, bookingsRes, contactsRes] = await Promise.all([
                fetchData('/api/doctors'),
                fetchData('/api/departments'),
                fetchData('/api/bookings'),
                fetchData('/api/contact')
            ]);

            document.getElementById('doctorsCount').textContent = doctorsRes.length;
            document.getElementById('departmentsCount').textContent = departmentsRes.length;
            document.getElementById('appointmentsCount').textContent = bookingsRes.length;
            document.getElementById('messagesCount').textContent = contactsRes.length;

            // Populate recent appointments
            const recentAppointments = bookingsRes.slice(0, 5);
            const appointmentsTable = document.querySelector('#recentAppointmentsTable tbody');
            appointmentsTable.innerHTML = '';
            
            recentAppointments.forEach(appointment => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${appointment.fullName}</td>
                    <td>${appointment.departmentName}</td>
                    <td>${new Date(appointment.preferredDate).toLocaleDateString('ar-EG')}</td>
                    <td>
                        <span class="badge ${appointment.isConfirmed ? 'bg-success' : 'bg-warning'}">
                            ${appointment.isConfirmed ? 'مؤكد' : 'قيد الانتظار'}
                        </span>
                    </td>
                `;
                appointmentsTable.appendChild(row);
            });

            // Populate recent messages
            const recentMessages = contactsRes.slice(0, 5);
            const messagesList = document.getElementById('recentMessagesList');
            messagesList.innerHTML = '';
            
            recentMessages.forEach(message => {
                const item = document.createElement('a');
                item.className = 'list-group-item list-group-item-action';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${message.name}</h6>
                        <small>${new Date(message.createdAt).toLocaleDateString('ar-EG')}</small>
                    </div>
                    <p class="mb-1 text-truncate">${message.message}</p>
                    <small>${message.email}</small>
                `;
                messagesList.appendChild(item);
            });

        } catch (error) {
            console.error('Error loading dashboard data:', error);
            showAlert('error', 'فشل تحميل بيانات لوحة التحكم');
        }
    }

    // Load all doctors
    async function loadDoctors() {
        try {
            const doctors = await fetchData('/api/doctors');
            doctorsTable.clear().draw();
            
            doctors.forEach(doctor => {
                doctorsTable.row.add([
                   `<img src="https://localhost:7230${doctor.imagePath}" alt="${doctor.name}" width="50" class="rounded-circle">`,
                    doctor.name,
                    doctor.specialty,
                    doctor.departmentName,
                    `
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary edit-doctor" data-id="${doctor.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-doctor" data-id="${doctor.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    `
                ]).draw(false);
            });

            // Add event listeners to action buttons
            document.querySelectorAll('.edit-doctor').forEach(btn => {
                btn.addEventListener('click', () => editDoctor(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-doctor').forEach(btn => {
                btn.addEventListener('click', () => confirmDelete('doctor', btn.dataset.id));
            });

        } catch (error) {
            console.error('Error loading doctors:', error);
            showAlert('error', 'فشل تحميل قائمة الأطباء');
        }
    }

    // Load all departments
    async function loadDepartments() {
        try {
            const departments = await fetchData('/api/departments');
            departmentsTable.clear().draw();
            
            departments.forEach(dept => {
                departmentsTable.row.add([
                    dept.name,
                    dept.description.length > 50 ? dept.description.substring(0, 50) + '...' : dept.description,
                    dept.doctorCount,
                    `
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary edit-department" data-id="${dept.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-department" data-id="${dept.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    `
                ]).draw(false);
            });

            // Add event listeners to action buttons
            document.querySelectorAll('.edit-department').forEach(btn => {
                btn.addEventListener('click', () => editDepartment(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-department').forEach(btn => {
                btn.addEventListener('click', () => confirmDelete('department', btn.dataset.id));
            });

        } catch (error) {
            console.error('Error loading departments:', error);
            showAlert('error', 'فشل تحميل قائمة الأقسام');
        }
    }

    // Load all blogs
    async function loadBlogs() {
        try {
            const blogs = await fetchData('/api/blogs');
            blogsTable.clear().draw();
            
            blogs.forEach(blog => {
                blogsTable.row.add([
                    
                    `<img src="https://localhost:7230${blog.imagePath}" alt="${blog.title}" width="50">`,
                    blog.title.length > 50 ? blog.title.substring(0, 50) + '...' : blog.title,
                    new Date(blog.createdAt).toLocaleDateString('ar-EG'),
                    `
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary edit-blog" data-id="${blog.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-blog" data-id="${blog.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    `
                ]).draw(false);
            });

            // Add event listeners to action buttons
            document.querySelectorAll('.edit-blog').forEach(btn => {
                btn.addEventListener('click', () => editBlog(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-blog').forEach(btn => {
                btn.addEventListener('click', () => confirmDelete('blog', btn.dataset.id));
            });

        } catch (error) {
            console.error('Error loading blogs:', error);
            showAlert('error', 'فشل تحميل المقالات');
        }
    }

    // Load all appointments
    async function loadAppointments() {
        try {
            const appointments = await fetchData('/api/Bookings');
            appointmentsTable.clear().draw();
            
            appointments.forEach(appt => {
                appointmentsTable.row.add([
                    appt.fullName,
                    appt.email,
                    appt.phoneNumber,
                    appt.departmentName,
                    new Date(appt.preferredDate).toLocaleDateString('ar-EG'),
                    `
                    <span class="badge ${appt.isConfirmed ? 'bg-success' : 'bg-warning'}">
                        ${appt.isConfirmed ? 'مؤكد' : 'قيد الانتظار'}
                    </span>
                    `,
                    `
                    <div class="btn-group">
                        <button class="btn btn-sm ${appt.isConfirmed ? 'btn-outline-warning' : 'btn-outline-success'} update-status" data-id="${appt.id}" data-status="${!appt.isConfirmed}">
                            <i class="fas ${appt.isConfirmed ? 'fa-times' : 'fa-check'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-appointment" data-id="${appt.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    `
                ]).draw(false);
            });

            // Add event listeners to action buttons
            document.querySelectorAll('.update-status').forEach(btn => {
                btn.addEventListener('click', () => updateAppointmentStatus(btn.dataset.id, btn.dataset.status === 'true'));
            });
            
            document.querySelectorAll('.delete-appointment').forEach(btn => {
                btn.addEventListener('click', () => confirmDelete('appointment', btn.dataset.id));
            });

        } catch (error) {
            console.error('Error loading appointments:', error);
            showAlert('error', 'فشل تحميل المواعيد');
        }
    }

    // Load all contacts
    async function loadContacts() {
        try {
            const contacts = await fetchData('/api/contact');
            contactsTable.clear().draw();
            
            contacts.forEach(contact => {
                contactsTable.row.add([
                    contact.name,
                    contact.email,
                    contact.message.length > 50 ? contact.message.substring(0, 50) + '...' : contact.message,
                    new Date(contact.createdAt).toLocaleDateString('ar-EG'),
                    `
                    <button class="btn btn-sm btn-outline-danger delete-contact" data-id="${contact.id}">
                        <i class="fas fa-trash"></i>
                    </button>
                    `
                ]).draw(false);
            });

            // Add event listeners to action buttons
            document.querySelectorAll('.delete-contact').forEach(btn => {
                btn.addEventListener('click', () => confirmDelete('contact', btn.dataset.id));
            });

        } catch (error) {
            console.error('Error loading contacts:', error);
            showAlert('error', 'فشل تحميل رسائل التواصل');
        }
    }

    // Doctor CRUD operations
    document.getElementById('addDoctorBtn').addEventListener('click', () => {
        document.getElementById('doctorModalTitle').textContent = 'إضافة طبيب جديد';
        document.getElementById('doctorId').value = '';
        document.getElementById('doctorForm').reset();
        document.getElementById('doctorImagePreviewContainer').style.display = 'none';
        
        // Load departments for dropdown
        loadDepartmentsForDropdown().then(() => {
            const modal = new bootstrap.Modal(document.getElementById('doctorModal'));
            modal.show();
        });
    });

    async function editDoctor(id) {
        try {
            const doctor = await fetchData(`/api/doctors/${id}`);
            
            document.getElementById('doctorModalTitle').textContent = 'تعديل بيانات الطبيب';
            document.getElementById('doctorId').value = doctor.id;
            document.getElementById('doctorName').value = doctor.name;
            document.getElementById('doctorSpecialty').value = doctor.specialty;
            document.getElementById('doctorBio').value = doctor.bio;
            
            // Load departments for dropdown and set selected
            await loadDepartmentsForDropdown();
            document.getElementById('doctorDepartment').value = doctor.departmentId;
            
            // Show image preview if exists
            if (doctor.imagePath) {
                 document.getElementById('doctorImagePreview').src = `https://localhost:7230${doctor.imagePath}`;
                
                document.getElementById('doctorImagePreviewContainer').style.display = 'block';
            } else {
                document.getElementById('doctorImagePreviewContainer').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('doctorModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error loading doctor:', error);
            showAlert('error', 'فشل تحميل بيانات الطبيب');
        }
    }

    async function loadDepartmentsForDropdown() {
        try {
            const departments = await fetchData('/api/departments');
            const dropdown = document.getElementById('doctorDepartment');
            dropdown.innerHTML = '<option value="">اختر القسم</option>';
            
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept.id;
                option.textContent = dept.name;
                dropdown.appendChild(option);
            });
            
        } catch (error) {
            console.error('Error loading departments:', error);
            showAlert('error', 'فشل تحميل الأقسام');
        }
    }

    document.getElementById('saveDoctorBtn').addEventListener('click', async () => {
        const form = document.getElementById('doctorForm');
        const id = document.getElementById('doctorId').value;
        const isEdit = !!id;
        
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return;
        }
        
        try {
            const formData = new FormData();
            formData.append('Name', document.getElementById('doctorName').value);
            formData.append('Specialty', document.getElementById('doctorSpecialty').value);
            formData.append('Bio', document.getElementById('doctorBio').value);
            formData.append('DepartmentId', document.getElementById('doctorDepartment').value);
            
            const imageFile = document.getElementById('doctorImage').files[0];
            if (imageFile) {
                formData.append('ImageFile', imageFile);
            }
            
            let response;
            if (isEdit) {
                formData.append('Id', id);
                response = await fetchData(`/api/doctors/${id}`, {
                    method: 'PUT',
                    body: formData
                }, false);
            } else {
                response = await fetchData('/api/doctors', {
                    method: 'POST',
                    body: formData
                }, false);
            }
            
            showAlert('success', `تم ${isEdit ? 'تحديث' : 'إضافة'} الطبيب بنجاح`);
            loadDoctors();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('doctorModal'));
            modal.hide();
            
        } catch (error) {
            console.error('Error saving doctor:', error);
            showAlert('error', `فشل في ${isEdit ? 'تحديث' : 'إضافة'} الطبيب`);
        }
    });

    // Department CRUD operations
    document.getElementById('addDepartmentBtn').addEventListener('click', () => {
        document.getElementById('departmentModalTitle').textContent = 'إضافة قسم جديد';
        document.getElementById('departmentId').value = '';
        document.getElementById('departmentForm').reset();
        document.getElementById('departmentImagePreviewContainer').style.display = 'none';
        document.getElementById('servicesContainer').innerHTML = '';
        
        // Add initial service field
        addServiceField();
        
        const modal = new bootstrap.Modal(document.getElementById('departmentModal'));
        modal.show();
    });

    async function editDepartment(id) {
        try {
            const department = await fetchData(`/api/departments/${id}`);
            const services = await fetchData(`/api/services/department/${id}`);
            
            document.getElementById('departmentModalTitle').textContent = 'تعديل بيانات القسم';
            document.getElementById('departmentId').value = department.id;
            document.getElementById('departmentName').value = department.name;
            document.getElementById('departmentDescription').value = department.description;
            
            // Show image preview if exists
            if (department.imagePath) {
                document.getElementById('departmentImagePreview').src = `https://localhost:7230${department.imagePath}`;
                document.getElementById('departmentImagePreviewContainer').style.display = 'block';
            } else {
                document.getElementById('departmentImagePreviewContainer').style.display = 'none';
            }
            
            // Clear existing services and add current ones
            document.getElementById('servicesContainer').innerHTML = '';
            if (services && services.length > 0) {
                services.forEach(service => {
                    addServiceField(service.id, service.name, service.description);
                });
            } else {
                addServiceField();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('departmentModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error loading department:', error);
            showAlert('error', 'فشل تحميل بيانات القسم');
        }
    }

    // Add service field to department form
    function addServiceField(id = '', name = '', description = '') {
        const container = document.getElementById('servicesContainer');
        const serviceId = id || Date.now(); // Use existing ID or generate a temporary one
        
        const serviceDiv = document.createElement('div');
        serviceDiv.className = 'service-entry mb-3 p-3 border rounded';
        serviceDiv.dataset.serviceId = serviceId;
        
        serviceDiv.innerHTML = `
            <div class="row">
                <div class="col-md-5 mb-2">
                    <label class="form-label">اسم الخدمة</label>
                    <input type="text" class="form-control service-name" value="${name}" required>
                </div>
                <div class="col-md-5 mb-2">
                    <label class="form-label">الوصف</label>
                    <input type="text" class="form-control service-description" value="${description}" required>
                </div>
                <div class="col-md-2 d-flex align-items-end mb-2">
                    <button type="button" class="btn btn-danger btn-sm remove-service">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        
        container.appendChild(serviceDiv);
        
        // Add event listener to remove button
        serviceDiv.querySelector('.remove-service').addEventListener('click', function() {
            if (container.children.length > 1) {
                container.removeChild(serviceDiv);
            } else {
                // Clear fields instead of removing the last service
                serviceDiv.querySelector('.service-name').value = '';
                serviceDiv.querySelector('.service-description').value = '';
            }
        });
    }

    // Add service button
    document.getElementById('addServiceBtn').addEventListener('click', function() {
        addServiceField();
    });

    document.getElementById('saveDepartmentBtn').addEventListener('click', async () => {
    const form = document.getElementById('departmentForm');
    const id = document.getElementById('departmentId').value;
    const isEdit = !!id;
    
    // Validate required fields
    const name = document.getElementById('departmentName').value;
    const description = document.getElementById('departmentDescription').value;
    
    if (!name || !description) {
        showAlert('error', 'حقل الاسم والوصف مطلوبان');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('Name', name);
        formData.append('Description', description);
        
        // Add image file if selected
        const imageFile = document.getElementById('departmentImage').files[0];
        if (imageFile) {
            formData.append('ImageFile', imageFile);
        }
        
        // Collect services data
        const services = [];
        document.querySelectorAll('.service-entry').forEach(serviceDiv => {
            const serviceName = serviceDiv.querySelector('.service-name').value;
            const serviceDescription = serviceDiv.querySelector('.service-description').value;
            
            if (serviceName && serviceDescription) {
                services.push({
                    Name: serviceName,
                    Description: serviceDescription
                });
            }
        });
        
        // Add services to form data as JSON string
        formData.append('ServicesJson', JSON.stringify(services));
        
        if (isEdit) {
            formData.append('Id', id);
            await fetchData(`/api/departments/${id}`, {
                method: 'PUT',
                body: formData
            }, false);
        } else {
            await fetchData('/api/departments', {
                method: 'POST',
                body: formData
            }, false);
        }
        
        showAlert('success', `تم ${isEdit ? 'تحديث' : 'إضافة'} القسم بنجاح`);
        loadDepartments();
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('departmentModal'));
        modal.hide();
        
    } catch (error) {
        console.error('Error saving department:', error);
        showAlert('error', `فشل في ${isEdit ? 'تحديث' : 'إضافة'} القسم: ${error.message}`);
    }
});

    // Blog CRUD operations
    document.getElementById('addBlogBtn').addEventListener('click', () => {
        document.getElementById('blogModalTitle').textContent = 'إضافة مقال جديد';
        document.getElementById('blogId').value = '';
        document.getElementById('blogForm').reset();
        document.getElementById('blogImagePreviewContainer').style.display = 'none';
        
        const modal = new bootstrap.Modal(document.getElementById('blogModal'));
        modal.show();
    });

    async function editBlog(id) {
        try {
            const blog = await fetchData(`/api/blogs/${id}`);
            
            document.getElementById('blogModalTitle').textContent = 'تعديل المقال';
            document.getElementById('blogId').value = blog.id;
            document.getElementById('blogTitle').value = blog.title;
            document.getElementById('blogContent').value = blog.content;
            
            // Show image preview if exists
            if (blog.imageUrl) {
                document.getElementById('blogImagePreview').src = blog.imageUrl;
                document.getElementById('blogImagePreviewContainer').style.display = 'block';
            } else {
                document.getElementById('blogImagePreviewContainer').style.display = 'none';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('blogModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error loading blog:', error);
            showAlert('error', 'فشل تحميل بيانات المقال');
        }
    }

    // Blog Form Submission
    document.getElementById('saveBlogBtn').addEventListener('click', async () => {
        const form = document.getElementById('blogForm');
        const id = document.getElementById('blogId').value;
        const isEdit = !!id;
        
        // Validate required fields
        const title = document.getElementById('blogTitle').value;
        const content = document.getElementById('blogContent').value;
        
        if (!title || !content) {
            showAlert('error', 'حقل العنوان والمحتوى مطلوبان');
            return;
        }

        try {
            const formData = new FormData();
            formData.append('Title', title);
            formData.append('Content', content);
            
            const imageFile = document.getElementById('blogImage').files[0];
            if (imageFile) {
                formData.append('ImageFile', imageFile);
            }

            if (isEdit) {
                formData.append('Id', id);
                await fetchData(`/api/blogs/${id}`, {
                    method: 'PUT',
                    body: formData
                }, false);
            } else {
                await fetchData('/api/blogs', {
                    method: 'POST',
                    body: formData
                }, false);
            }
            
            showAlert('success', `تم ${isEdit ? 'تحديث' : 'إضافة'} المقال بنجاح`);
            loadBlogs();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('blogModal'));
            modal.hide();
            
        } catch (error) {
            console.error('Error saving blog:', error);
            showAlert('error', `فشل في ${isEdit ? 'تحديث' : 'إضافة'} المقال: ${error.message}`);
        }
    });

    // Appointment status update
    async function updateAppointmentStatus(id, status) {
        try {
            await fetchData(`/api/bookings/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    Id: parseInt(id),
                    IsConfirmed: status
                })
            });
            
            showAlert('success', 'تم تحديث حالة الموعد بنجاح');
            loadAppointments();
            
        } catch (error) {
            console.error('Error updating appointment:', error);
            showAlert('error', 'فشل تحديث حالة الموعد');
        }
    }

    // Delete confirmation
    let currentDeleteType = '';
    let currentDeleteId = '';

    function confirmDelete(type, id) {
        currentDeleteType = type;
        currentDeleteId = id;
        
        const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
        document.getElementById('confirmationMessage').textContent = `هل أنت متأكد أنك تريد حذف هذا ${type === 'doctor' ? 'الطبيب' : type === 'department' ? 'القسم' : type === 'blog' ? 'المقال' : type === 'appointment' ? 'الموعد' : 'الرسالة'}؟`;
        modal.show();
    }

    document.getElementById('confirmActionBtn').addEventListener('click', async () => {
        try {
            let endpoint = '';
            switch (currentDeleteType) {
                case 'doctor':
                    endpoint = `/api/doctors/${currentDeleteId}`;
                    break;
                case 'department':
                    endpoint = `/api/departments/${currentDeleteId}`;
                    break;
                case 'blog':
                    endpoint = `/api/blogs/${currentDeleteId}`;
                    break;
                case 'appointment':
                    endpoint = `/api/bookings/${currentDeleteId}`;
                    break;
                case 'contact':
                    endpoint = `/api/contacts/${currentDeleteId}`;
                    break;
            }
            
            await fetchData(endpoint, {
                method: 'DELETE'
            });
            
            showAlert('success', `تم حذف ${currentDeleteType === 'doctor' ? 'الطبيب' : currentDeleteType === 'department' ? 'القسم' : currentDeleteType === 'blog' ? 'المقال' : currentDeleteType === 'appointment' ? 'الموعد' : 'الرسالة'} بنجاح`);
            
            // Refresh the appropriate table
            switch (currentDeleteType) {
                case 'doctor':
                    loadDoctors();
                    break;
                case 'department':
                    loadDepartments();
                    break;
                case 'blog':
                    loadBlogs();
                    break;
                case 'appointment':
                    loadAppointments();
                    break;
                case 'contact':
                    loadContacts();
                    break;
            }
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
            modal.hide();
            
        } catch (error) {
            console.error('Error deleting:', error);
            showAlert('error', `فشل حذف ${currentDeleteType === 'doctor' ? 'الطبيب' : currentDeleteType === 'department' ? 'القسم' : currentDeleteType === 'blog' ? 'المقال' : currentDeleteType === 'appointment' ? 'الموعد' : 'الرسالة'}`);
        }
    });

    // Image preview handlers
    document.getElementById('doctorImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('doctorImagePreview').src = event.target.result;
                document.getElementById('doctorImagePreviewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('blogImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('blogImagePreview').src = event.target.result;
                document.getElementById('blogImagePreviewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('departmentImage').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                document.getElementById('departmentImagePreview').src = event.target.result;
                document.getElementById('departmentImagePreviewContainer').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('healthcare_token');
        localStorage.removeItem('healthcare_user');
        window.location.href = 'login.html';
    });

    // Helper function to fetch data
    async function fetchData(endpoint, options = {}, isJson = true) {
        const token = localStorage.getItem('healthcare_token');
        
        if (!token) {
            window.location.href = 'login.html';
            throw new Error('No token found');
        }

        const defaultOptions = {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        };
        
        const finalOptions = {
            ...defaultOptions,
            ...options
        };
        
        // Don't set Content-Type for FormData
        if (!(finalOptions.body instanceof FormData)) {
            finalOptions.headers['Content-Type'] = 'application/json';
        }
        
        const response = await fetch(`https://localhost:7230${endpoint}`, finalOptions);
        
        if (!response.ok) {
            let errorMsg = 'Request failed';
            try {
                const errorData = await response.json();
                errorMsg = errorData.message || JSON.stringify(errorData);
            } catch (e) {
                errorMsg = await response.text();
            }
            throw new Error(errorMsg);
        }
        
        // Handle empty responses (204 No Content)
        if (response.status === 204) {
            return null;
        }
        
        return isJson ? await response.json() : response;
    }

    // Show alert message
    function showAlert(type, message) {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alert.style.top = '20px';
        alert.style.right = '20px';
        alert.style.zIndex = '9999';
        alert.style.minWidth = '300px';
        alert.role = 'alert';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        document.body.appendChild(alert);
        
        setTimeout(() => {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }, 5000);
    }

    // Initialize dashboard on load
    loadDashboardData();
    loadDoctors();
    loadDepartments();
    loadBlogs();
    loadAppointments();
    loadContacts();
});
    </script>
</body>
</html>